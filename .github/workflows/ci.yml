name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  json-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate JSON syntax
        run: |
          jq . .claude-plugin/plugin.json
          jq . settings.json
      - name: Check plugin.json required fields
        run: jq -e '.name and .version and .description' .claude-plugin/plugin.json

  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Lint shell scripts
        run: |
          shellcheck skills/mopro-env/scripts/check-env.sh
          shellcheck skills/mopro-device/scripts/list-devices.sh
      - name: Syntax check shell scripts
        run: |
          bash -n skills/mopro-env/scripts/check-env.sh
          bash -n skills/mopro-device/scripts/list-devices.sh

  plugin-structure:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate plugin structure
        run: bash tests/validate-structure.sh

  agent-agnostic:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check AGENTS.md exists
        run: test -f AGENTS.md
      - name: Validate CLAUDE.md symlink
        run: |
          if [ ! -L CLAUDE.md ]; then
            echo "FAIL: CLAUDE.md is not a symlink"
            exit 1
          fi
          target=$(readlink CLAUDE.md)
          if [ "$target" != "AGENTS.md" ]; then
            echo "FAIL: CLAUDE.md points to '$target', expected AGENTS.md"
            exit 1
          fi
          echo "OK: CLAUDE.md -> AGENTS.md"
      - name: Check rules file exists
        run: test -f .claude/rules/build-background.md
      - name: Validate SKILL.md name fields
        run: |
          for skill in skills/*/SKILL.md; do
            if ! grep -q '^name:' "$skill"; then
              echo "FAIL: $skill missing required name field"
              exit 1
            fi
            echo "OK: $skill has name field"
          done
      - name: Check no SKILL_DIR in SKILL.md files
        run: |
          if grep -rl '\$SKILL_DIR' skills/*/SKILL.md; then
            echo "FAIL: SKILL.md files must use relative paths, not \$SKILL_DIR"
            exit 1
          fi
          echo "OK: no \$SKILL_DIR references in SKILL.md files"

  script-output:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate check-env.sh JSON output
        run: bash skills/mopro-env/scripts/check-env.sh all | jq .
      - name: Validate list-devices.sh JSON output
        run: bash skills/mopro-device/scripts/list-devices.sh all | jq .
